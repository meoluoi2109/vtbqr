<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>VietinBank QR</title>
  <style>
    :root{
      --brand:#0b7cc2; --ink:#0a2a44; --muted:#6b7280; --panel:#ffffff; --r:12px;
      --bg1:#e9f6ff; --bg2:#d4edff; --shadow:0 8px 20px rgba(0,0,0,.1);
      --ring:0 0 0 3px rgba(11,124,194,.15);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--ink);background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    .app{height:100vh;height:100dvh;display:flex;flex-direction:column;--preview-height: 73%; /* Chi·ªÅu cao t·ªëi ƒëa cho ph·∫ßn xem tr∆∞·ªõc */
    --controls-height: 27%; /* Chi·ªÅu cao t·ªëi thi·ªÉu cho ph·∫ßn ƒëi·ªÅu khi·ªÉn */}

    /* Preview */
    .preview{flex-shrink:0; display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px;flex: 0 1 var(--preview-height);min-height: 350px;}
    .export-top{display:flex;gap:8px;width:100%;max-width:360px;justify-content: center}
    .btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:10px 12px;border:0;border-radius:8px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    .btn.muted{background:#6b7280}
    .btn.sec{background:#0f9b7b}

    /* Card 2:3 ‚Äî preview DOM; export will render exactly 1360√ó2040 */
    .card{position:relative;width:min(100%,360px);aspect-ratio:2/3;border-radius:12px;overflow:hidden;box-shadow:0 16px 40px rgba(13,63,97,.2);background:#b7dcff}

    /* Background */
    .bg-wrap{position:absolute;inset:0;overflow:hidden}
    .bg-wrap img{position:absolute;inset:auto;top:0;left:50%;transform:translateX(-50%);height:100%;width:auto;image-rendering:auto;-ms-interpolation-mode:nearest-neighbor}

    .qr-box,.title,.account,.alias,.footer{position:absolute;user-select:none;cursor:grab}
    .qr-box{left:50%;top:28%;transform:translate(-50%,-50%);width:200px;height:200px;background:#fff;border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .qr-box img{display:block;max-width:100%;max-height:100%;border-radius:6px}

    .title{left:50%;top:58%;transform:translate(-50%,0);text-align:center;color:#355a78;text-transform:uppercase;font-weight:800;letter-spacing:.02em;line-height:1.15;font-size:18px;padding:0 8px}
    .account{left:50%;top:66%;transform:translate(-50%,0);text-align:center;color:#355a78;font-weight:800;font-size:16px}
    .alias{left:50%;top:72%;transform:translate(-50%,0);text-align:center;color:#355a78;font-weight:700;font-size:14px;display:none}
    .footer{left:50%;bottom:2%;transform:translate(-50%,0);text-align:center;color:#355a78;font-size:10px;line-height:1.35;font-weight:700;padding:0 8px 8px}

    .dragging{outline:2px solid var(--brand);cursor:grabbing!important;z-index:10}
    .selected{outline:2px solid var(--brand);outline-offset:2px}

    /* Control panel */
    .controls{flex:1;display:flex;flex-direction:column;background:#fff;border-radius:12px 12px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,.08);overflow:hidden;flex: 1 1 var(--controls-height);position:relative}
    .tabs{display:flex;border-bottom:1px solid #e5e7eb;background:#f9fafb;overflow-x:auto}
    .tab{flex:1;padding:8px 10px;font-size:12px;font-weight:700;text-align:center;background:transparent;color:#6b7280;border:0;border-bottom:2px solid transparent;white-space:nowrap}
    .tab.active{color:var(--brand);border-bottom-color:var(--brand);background:#fff}
    .panel{flex:1;overflow:auto;padding:10px}
    .section{background:#f9fafb;border-radius:8px;padding:8px;margin-bottom:8px}
    .section-title{font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:800;letter-spacing:.05em;margin-bottom:6px}
    .field{margin-bottom:6px}
    .label{font-size:11px;color:#6b7280;margin-bottom:2px;font-weight:700}
    input[type="text"],input[type="number"],input[type="color"],textarea{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px}
    input:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:var(--ring)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .check{display:flex;align-items:center;gap:6px;font-size:12px}

    .gallery{display:grid; grid-template-columns:repeat(auto-fill, minmax(72px,1fr)); gap:8px; max-height:144px; overflow:auto}
    @media (max-width:420px){ .gallery{grid-template-columns:repeat(4,1fr)} }
    .g-item{aspect-ratio:1; border-radius:8px; overflow:hidden; border:2px solid transparent; position:relative}
    .g-item img{width:100%; height:100%; object-fit:cover}
    .g-item.selected{border-color:var(--brand)}
    .g-del{position:absolute; top:4px; right:4px; width:22px; height:22px; border-radius:50%; border:0; background:rgba(220,38,38,.95); color:#fff; font-weight:800; cursor:pointer}

    /* Smartbar - FIXED POSITION IN CONTROLS */
    .smartbar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      padding: 12px;
      z-index: 100;
      display: none;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    }
    .smartbar header{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:6px;user-select:none}
    .smart-title{font-weight:800;font-size:12px}
    .smart-btn{height:36px;width:36px;border-radius:8px;border:1px solid rgba(11,124,194,.2);background:linear-gradient(180deg,#fff,#f6fbff);box-shadow:0 4px 10px rgba(10,42,68,.08);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .smart-close{background:linear-gradient(180deg,#ff8080,#e64040);color:#fff}
    .smart-range{width:100%}

    /* New prominent color chip */
    .smart-color-chip{position:relative;height:36px;width:60px;border-radius:10px;border:2px solid rgba(11,124,194,.35);box-shadow:inset 0 0 0 3px #fff, 0 2px 8px rgba(10,42,68,.12); cursor:pointer}
    .smart-color-chip::after{content:""; position:absolute; inset:-4px; border-radius:12px; box-shadow:0 0 0 2px rgba(11,124,194,.15); pointer-events:none}
    .smart-color-hidden{position:absolute; width:1px; height:1px; padding:0; border:0; clip:rect(0 0 0 0); overflow:hidden;}

    /* iOS Color Picker */
    .ios-color-picker {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .ios-color-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 300px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .ios-color-title {
      font-weight: 700;
      margin-bottom: 15px;
      text-align: center;
      color: var(--ink);
    }
    .ios-color-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    .ios-color-option {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
    }
    .ios-color-option.selected {
      border-color: var(--brand);
      box-shadow: 0 0 0 2px white, 0 0 0 4px var(--brand);
    }
    .ios-color-custom {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .ios-color-custom input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
    }
    .ios-color-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }
    .ios-color-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
    }
    .ios-color-confirm {
      background: var(--brand);
      color: white;
    }
    .ios-color-cancel {
      background: #f3f4f6;
      color: var(--ink);
    }

    @media (min-width:768px){
      .app{max-width:1200px;margin:0 auto;flex-direction:row;padding:12px;gap:12px}
      .preview{flex:0 0 45%;height:auto; justify-content: center;}
      .card{width:100%;max-width:420px}
      .smartbar{bottom: 0; left: 0; right: 0}
      .controls{border-radius:12px;box-shadow:var(--shadow)}
      .gallery{grid-template-columns:repeat(4,1fr);max-height:220px}
    }
  
    @media (max-width: 640px){
      .gallery{ grid-template-columns:repeat(auto-fill, minmax(72px,1fr)); gap:8px; }
      .g-item img{ height:56px; }
    }
  
/* === Compact Gallery (ported from mobile style, tighter) === */
.gallery{display:grid; grid-template-columns:repeat(auto-fill, minmax(72px,1fr)); gap:8px; max-height:144px; overflow:auto}
.gallery-compact{grid-template-columns:repeat(auto-fill, minmax(64px,1fr)); grid-auto-rows:64px}
.g-item{width:100%; height:100%; aspect-ratio:auto; border-radius:8px; overflow:hidden; border:2px solid transparent; position:relative}
.g-item img{width:100%; height:100%; object-fit:cover}
.g-item.selected{ border-color:var(--brand) }
.g-del{position:absolute; top:4px; right:4px; width:22px; height:22px; border-radius:50%; border:0; background:rgba(220,38,38,.95); color:#fff; font-weight:800; cursor:pointer}
.gallery-wrap{border:1px solid #e5e7eb; border-radius:10px; padding:6px; background:#fafafa}
.gallery-wrap > summary{list-style:none; cursor:pointer; font-size:12px; font-weight:700; color:#374151}
.gallery-wrap > summary::-webkit-details-marker{display:none}
@media (max-width:640px){
  .gallery{grid-template-columns:repeat(auto-fill, minmax(56px,1fr)); gap:6px; max-height:128px}
  .gallery-compact{grid-auto-rows:56px}
}

</style>
</head>
<body>
  <div class="app">
    <section class="preview">
      <div class="card hoverable" id="card">
        <div class="bg-wrap"><img id="bgImg" alt="Background" /></div>

        <div class="qr-box hoverable" id="qrBox"><img id="qr" alt="QR" /></div>
        <div class="title hoverable" id="title"><span id="titleText">T√™n TK: VIETINBANK CN L√ÄO CAI</span></div>
        <div class="account hoverable" id="accountLine"><span id="accountVal">S·ªë TK: 108888884567</span></div>
        <div class="alias hoverable" id="aliasLine"><span id="aliasVal">Alias: BINHTK</span></div>
        <div class="footer hoverable" id="footer">
          <div id="f1">VietinBank - CN L√†o Cai</div>
          <div id="f2">Ph√≤ng D·ªãch v·ª• Kh√°ch H√†ng</div>
          <div id="f3">ƒê·∫°i l·ªô Tr·∫ßn H∆∞ng ƒê·∫°o, Ph∆∞·ªùng Cam ƒê∆∞·ªùng, T·ªânh L√†o Cai</div>
        </div>
      </div>
    </section>

    <section class="controls">
      <div class="tabs" id="tabs">
        <button class="tab active" data-t="info">üìù Th√¥ng tin</button>
        <button class="tab" data-t="bg">üñºÔ∏è ·∫¢nh n·ªÅn</button>
        <button class="tab" data-t="footer">üìÑ Footer</button>
        <button class="tab" data-t="download">‚¨áÔ∏è T·∫£i ·∫£nh</button>
      </div>

      <div class="smartbar" id="smartbar">
        <header>
          <div id="smartTitle" class="smart-title">Ch·ªânh s·ª≠a</div>
          <label class="check"><input type="checkbox" id="smartCenter"> CƒÉn gi·ªØa</label>
          <button class="smart-btn smart-close" id="smartClose">‚úï</button>
        </header>
        <div class="controls" style="display:grid;grid-template-columns:repeat(4,36px) 1fr auto;gap:6px;align-items:center">
          <button class="smart-btn" id="nudgeUp">‚Üë</button>
          <button class="smart-btn" id="nudgeLeft">‚Üê</button>
          <button class="smart-btn" id="nudgeRight">‚Üí</button>
          <button class="smart-btn" id="nudgeDown">‚Üì</button>
          <input class="smart-range" type="range" id="smartSize" min="8" max="48" value="18">
          <div id="smartColorWrap">
            <div class="smart-color-chip" id="smartColorChip" title="Ch·ªçn m√†u"></div>
            <!-- ƒê√É S·ª¨A: Thay v√¨ ·∫©n ho√†n to√†n, ƒë·ªÉ input color c√≥ th·ªÉ click ƒë∆∞·ª£c -->
            <input type="color" id="smartColor" style="position:absolute; opacity:0; width:60px; height:36px; cursor:pointer">
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-body" data-p="info">
          <div class="section">
            <div class="section-title">üë§ Ng∆∞·ªùi th·ª• h∆∞·ªüng</div>
            <div class="field">
              <input type="text" id="titleInput" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi th·ª• h∆∞·ªüng">
            </div>
          </div>
          <div class="section">
            <div class="section-title">üí≥ S·ªë t√†i kho·∫£n</div>
            <div class="field">
              <input type="text" id="accInput" inputmode="numeric" placeholder="Nh·∫≠p s·ªë t√†i kho·∫£n">
            </div>
            <label class="check"><input type="checkbox" id="accVisible" checked> Hi·ªÉn th·ªã s·ªë t√†i kho·∫£n</label>
          </div>
          <div class="section">
            <div class="section-title">üè∑Ô∏è Alias</div>
            <div class="field">
              <input type="text" id="aliasInput" placeholder="Nh·∫≠p alias">
            </div>
            <label class="check"><input type="checkbox" id="aliasVisible"> Hi·ªÉn th·ªã Alias</label>
          </div>
        </div>

        <div class="panel-body" data-p="bg" hidden>
          <div class="section">
            <div class="section-title">üñºÔ∏è Ch·ªçn ·∫£nh n·ªÅn (Size ·∫£nh 1181x1713)</div>
            <div class="row">
              <button class="btn" id="pickBg" type="button">üîç Ch·ªçn ·∫£nh</button>
              <button class="btn sec" id="pickDir" type="button">üìÇ Ch·ªçn th∆∞ m·ª•c</button>
            </div>
            <input type="file" id="bgFile" accept="image/*" multiple hidden>
            <input type="file" id="dirPicker" accept="image/*" webkitdirectory directory multiple hidden>
          </div>
          <details class="gallery-wrap" style="margin-top:8px">
  <summary id="gallerySummary">üñºÔ∏è Th∆∞ vi·ªán (0) ‚Äî ·∫•n ƒë·ªÉ m·ªü</summary>
  <div class="gallery gallery-compact" id="gallery"></div>
</details>
        </div>

        <div class="panel-body" data-p="footer" hidden>
          <div class="section">
            <div class="section-title">üìÑ N·ªôi dung Footer</div>
            <label class="check"><input type="checkbox" id="footerVisible" checked> Hi·ªÉn th·ªã Footer</label>
            <div class="field"><div class="label">D√≤ng 1</div><input type="text" id="f1Input" value="VietinBank - CN L√†o Cai"></div>
            <div class="field"><div class="label">D√≤ng 2</div><input type="text" id="f2Input" value="Ph√≤ng D·ªãch v·ª• Kh√°ch H√†ng"></div>
            <div class="field"><div class="label">D√≤ng 3</div><input type="text" id="f3Input" value="ƒê·∫°i l·ªô Tr·∫ßn H∆∞ng ƒê·∫°o, Ph∆∞·ªùng Cam ƒê∆∞·ªùng, T·ªânh L√†o Cai"></div>
          </div>
          <div class="section">
            <div class="section-title">üíæ L∆∞u tr·ªØ</div>
            <div class="row">
              <button class="btn sec" id="footerSave" type="button">üíæ L∆∞u</button>
              <button class="btn muted" id="footerLoad" type="button">‚Ü©Ô∏è Kh√¥i ph·ª•c</button>
            </div>
          </div>
        </div>

        <div class="panel-body" data-p="download" hidden>
          <div class="section">
            <div class="section-title">‚¨áÔ∏è T·∫£i ·∫£nh QR</div>
            <p style="font-size:12px; color: var(--muted); margin-bottom:8px;">T·∫£i ·∫£nh QR Code</p>
            <button class="btn" id="exportBtn" type="button">‚¨áÔ∏è T·∫£i PNG</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- iOS Color Picker Modal -->
  <div class="ios-color-picker" id="iosColorPicker">
    <div class="ios-color-panel">
      <div class="ios-color-title">Ch·ªçn m√†u</div>
      <div class="ios-color-grid" id="colorGrid">
        <!-- C√°c √¥ m√†u s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </div>
      <div class="ios-color-custom">
        <input type="text" id="customColorInput" placeholder="#000000" maxlength="7">
        <button class="ios-color-btn" id="applyCustomColor" style="padding: 8px 12px;">√Åp d·ª•ng</button>
      </div>
      <div class="ios-color-actions">
        <button class="ios-color-btn ios-color-cancel" id="cancelColorPicker">H·ªßy</button>
        <button class="ios-color-btn ios-color-confirm" id="confirmColorPicker">Xong</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
  // ƒê·∫£m b·∫£o DOM ƒë√£ t·∫£i ho√†n to√†n tr∆∞·ªõc khi th·ª±c thi m√£ JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    const $ = id => document.getElementById(id);
    
    // Ki·ªÉm tra xem c√°c ph·∫ßn t·ª≠ c·∫ßn thi·∫øt c√≥ t·ªìn t·∫°i kh√¥ng
    if (!$('card')) {
      console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ card');
      return;
    }
    
    const card = $('card');
    const bgImg = $('bgImg');
    const qrBox = $('qrBox');
    const qrEl = $('qr');
    const title = $('title');
    const titleText = $('titleText');
    const accLine = $('accountLine');
    const accVal = $('accountVal');
    const aliasLine = $('aliasLine');
    const aliasVal = $('aliasVal');
    const footer = $('footer');
    const f1 = $('f1'), f2 = $('f2'), f3 = $('f3');

    // ===== Tabs =====
    const tabs = $('tabs');
    const panels = [...document.querySelectorAll('[data-p]')];
    if (tabs) {
      tabs.addEventListener('click', (e)=>{
        const btn = e.target.closest('.tab'); if(!btn) return;
        const t = btn.dataset.t;
        tabs.querySelectorAll('.tab').forEach(b=> b.classList.toggle('active', b.dataset.t===t));
        panels.forEach(p => p.hidden = (p.dataset.p !== t));
      });
    }

    // ===== Drag move & center =====
    const center = {qrBox:true, title:true, accountLine:true, aliasLine:true, footer:true};
    let dragTarget=null, offsetX=0, offsetY=0;
    const rectCard = ()=> card.getBoundingClientRect();
    const clamp=(n,min,max)=> Math.max(min, Math.min(max, n));

    function beginDrag(target, x, y){
      dragTarget=target; const r = target.getBoundingClientRect(); const id = target.id;
      if(center[id]){ offsetY = y - r.top; offsetX = (id==='qrBox') ? x - r.left : 0; }
      else { offsetX = x - r.left; offsetY = y - r.top; }
      target.classList.add('dragging');
    }
    function moveDrag(x,y){
      if(!dragTarget) return; const c = rectCard(); const id = dragTarget.id;
      if(center[id]){
        const top = clamp(y - c.top - offsetY, 0, c.height - dragTarget.offsetHeight);
        dragTarget.style.top = top + 'px';
        if(id==='qrBox'){
          const w = dragTarget.offsetWidth; const left = (c.width - w) / 2; dragTarget.style.left = left + 'px'; dragTarget.style.transform = 'translate(0,0)';
        }else{ dragTarget.style.left='0'; dragTarget.style.right='0'; dragTarget.style.textAlign='center'; dragTarget.style.transform='translate(0,0)'; }
      }else{
        const left = clamp(x - c.left - offsetX, 0, c.width - dragTarget.offsetWidth);
        const top  = clamp(y - c.top  - offsetY, 0, c.height - dragTarget.offsetHeight);
        dragTarget.style.left = left + 'px';
        dragTarget.style.top = top + 'px';
        dragTarget.style.right=''; dragTarget.style.transform='translate(0,0)';
      }
    }
    function endDrag(){ if(dragTarget){ dragTarget.classList.remove('dragging'); dragTarget=null; } }
    function wireDrag(id){
      const node=$(id);
      if (!node) {
        console.warn('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ ƒë·ªÉ k√©o: ' + id);
        return;
      }
      node.addEventListener('mousedown', (e)=>{ e.preventDefault(); beginDrag(node, e.clientX, e.clientY); });
      document.addEventListener('mousemove', (e)=> moveDrag(e.clientX, e.clientY));
      document.addEventListener('mouseup', endDrag);
      node.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; beginDrag(node, t.clientX, t.clientY); }, {passive:false});
      document.addEventListener('touchmove', (e)=>{ if(!dragTarget) return; const t=e.touches[0]; moveDrag(t.clientX,t.clientY); e.preventDefault(); }, {passive:false});
      document.addEventListener('touchend', endDrag);
    }
    ['qrBox','title','accountLine','aliasLine','footer'].forEach(wireDrag);

    function applyCenter(id){
      const el=$(id); 
      if (!el) return;
      const c = rectCard();
      if(center[id]){
        if(id==='qrBox'){
          const w = el.offsetWidth; el.style.left = ((c.width - w)/2) + 'px'; el.style.transform='translate(0,0)';
        }else{
          el.style.left='0'; el.style.right='0'; el.style.textAlign='center'; el.style.transform='translate(0,0)';
        }
      }
    }

    // ===== Inputs =====
    const titleInput=$('titleInput');
    const accInput=$('accInput'), accVisible=$('accVisible');
    const aliasInput=$('aliasInput'), aliasVisible=$('aliasVisible');
    const footerVisible=$('footerVisible'), f1Input=$('f1Input'), f2Input=$('f2Input'), f3Input=$('f3Input');
    let footerFontPx = 10;
    let footerColorHex = '#355a78';
    let qrUserSize = null;

    function updateQR(){
      const acc = (accInput.value||'').replace(/\D/g,'');
      if(acc){
        qrEl.crossOrigin = 'anonymous';
        qrEl.src = `https://img.vietqr.io/image/970415-${acc}-QY3QZ1v.jpg`;
      }
    }

    function updateAll(){
      const c = rectCard();
      const size = (qrUserSize ?? Math.min(220, Math.floor(c.width*0.85)));
      qrBox.style.width = qrBox.style.height = size+'px';
      const tt = (titleInput.value||'').toUpperCase();
      titleText.textContent = 'T√™n TK: ' + tt;
      accLine.style.display = accVisible.checked ? 'block' : 'none';
      accVal.textContent = 'S·ªë TK: ' + (accInput.value||'').replace(/\D/g,'');
      aliasLine.style.display = aliasVisible.checked ? 'block' : 'none';
      aliasVal.textContent = 'Alias: ' + (aliasInput.value||'');
      footer.style.display = footerVisible.checked ? 'block' : 'none';
      [f1,f2,f3].forEach(n => { 
        if (n) {
          n.style.fontSize = footerFontPx + 'px'; 
          n.style.color = footerColorHex; 
        }
      });
      footer.style.color = footerColorHex;
      applyCenter('qrBox'); applyCenter('title'); applyCenter('accountLine'); applyCenter('aliasLine'); applyCenter('footer');
    }

    [titleInput, accInput, accVisible, aliasInput, aliasVisible, footerVisible, f1Input, f2Input, f3Input]
      .forEach(n=> {
        if (n) {
          n.addEventListener('input', ()=>{ if(n===accInput) updateQR(); updateAll(); });
        }
      });

    // ===== Gallery / Background loader =====
    const images=[]; let selectedIdx=-1;
    function renderGallery(){ 
      const gallery = $('gallery');
      if (!gallery) return;
      
      gallery.innerHTML = images.map((src,i)=>`<div class="g-item ${i===selectedIdx?'selected':''}" onclick="selectImg(${i})"><img loading="lazy" decoding="async" src="${src}"><button class=\"g-del\" onclick=\"event.stopPropagation();delImg(${i})\">√ó</button></div>`).join('');
      const gallerySummary = $('gallerySummary');
      if (gallerySummary) {
        gallerySummary.textContent = `üñºÔ∏è Th∆∞ vi·ªán (${images.length})`;
      }
    }
    window.selectImg=(i)=>{ selectedIdx=i; bgImg.src = images[i]; renderGallery(); };
    window.delImg=(i)=>{ images.splice(i,1); if(selectedIdx===i){ selectedIdx=images.length?0:-1; if(selectedIdx>=0) selectImg(selectedIdx); else setDefaultBG(); } else if(selectedIdx>i) selectedIdx--; renderGallery(); };
    function addFilesToGallery(files){ if(!files||!files.length) return; let first=images.length===0; for(const f of files){ if(f?.type?.startsWith('image/')){ const r=new FileReader(); r.onload=e=>{ images.push(e.target.result); renderGallery(); if(first){ selectImg(0); first=false; } }; r.readAsDataURL(f); } } }
    
    const pickBg = $('pickBg');
    const pickDir = $('pickDir');
    const bgFile = $('bgFile');
    const dirPicker = $('dirPicker');
    
    if (pickBg && bgFile) {
      pickBg.onclick = ()=> bgFile.click();
    }
    if (pickDir && dirPicker) {
      pickDir.onclick = ()=> dirPicker.click();
    }
    if (bgFile) {
      bgFile.onchange = (e)=> addFilesToGallery([...e.target.files]);
    }
    if (dirPicker) {
      dirPicker.onchange = (e)=> addFilesToGallery([...e.target.files]);
    }

    function setDefaultBG(){
      const svg = encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='1360' height='2040'>
          <defs>
            <linearGradient id='g' x1='0' x2='1' y1='0' y2='1'>
              <stop offset='0%' stop-color='#e6f3ff'/>
              <stop offset='100%' stop-color='#b7dcff'/>
            </linearGradient>
          </defs>
          <rect width='100%' height='100%' fill='url(#g)'/>
          <path d='M0,260 C340,200 580,320 1360,220 L1360,0 L0,0 Z' fill='#0b7cc2' fill-opacity='.08'/>
          <path d='M0,420 C420,360 760,500 1360,380 L1360,0 L0,0 Z' fill='#0b7cc2' fill-opacity='.06'/>
        </svg>
      `);
      bgImg.src = 'data:image/svg+xml;charset=utf-8,' + svg;
    }
    
    const GITHUB_SOURCE_DIR = 'source';
    const DEFAULT_BG_NAME   = 'background-default.png';
    function meta(name){ return document.querySelector(`meta[name="${name}"]`)?.content?.trim(); }
    function detectOwnerRepo(){
      const mo = meta('gh-owner'); const mr = meta('gh-repo');
      if(mo && mr) return {owner: mo, repo: mr};
      const {hostname, pathname} = window.location; const parts = pathname.split('/').filter(Boolean);
      if(hostname.endsWith('.github.io') && parts.length>0){ const owner = hostname.split('.')[0]; const repo  = parts[0]; return {owner, repo}; }
      return null;
    }
    async function listImagesViaGitHubAPI(){
      const info = detectOwnerRepo(); if(!info) return [];
      const branches = ['gh-pages','main','master'];
      for(const br of branches){
        const api = `https://api.github.com/repos/${info.owner}/${info.repo}/contents/${GITHUB_SOURCE_DIR}?ref=${br}`;
        try{
          const res = await fetch(api, {headers:{'Accept':'application/vnd.github+json'}, cache:'no-store'}); if(!res.ok) continue;
          const arr = await res.json(); if(!Array.isArray(arr)) continue;
          const imgs = arr.filter(x=>x.type==='file' && /\.(png|jpe?g|webp|svg)$/i.test(x.name)).map(x=>({ name:x.name, raw:`https://raw.githubusercontent.com/${info.owner}/${info.repo}/${br}/${GITHUB_SOURCE_DIR}/${encodeURIComponent(x.name)}` }));
          if(imgs.length) return imgs;
        }catch(e){ /* try next branch */ }
      }
      return [];
    }
    async function initGalleryFromGithub(){
      images.length = 0; selectedIdx = -1;
      const results = await listImagesViaGitHubAPI();
      if(results.length){
        results.forEach(it=> images.push(it.raw));
        const defIdx = results.findIndex(it => it.name.toLowerCase() === DEFAULT_BG_NAME.toLowerCase());
        window.selectImg(defIdx >= 0 ? defIdx : 0);
        return true;
      }
      return false;
    }

    // ===== Smartbar =====
    let selectedId = null;
    const smartbar = $('smartbar');
    const smartTitle = $('smartTitle');
    const smartSize = $('smartSize');
    const smartCenter = $('smartCenter');
    const smartClose = $('smartClose');
    const smartColor = $('smartColor');
    const smartColorChip = $('smartColorChip');
    const smartColorWrap = $('smartColorWrap');
    const nudgeUp = $('nudgeUp');
    const nudgeDown = $('nudgeDown');
    const nudgeLeft = $('nudgeLeft');
    const nudgeRight = $('nudgeRight');
    const NAME_MAP = { 'qrBox':'QR Code', 'title':'T√™n ng∆∞·ªùi th·ª• h∆∞·ªüng', 'accountLine':'S·ªë t√†i kho·∫£n', 'aliasLine':'Alias', 'footer':'Footer' };

    function rgb2hex(rgb){
      const nums = (rgb||'').replace(/[^\d,]/g,'').split(',');
      if(nums.length<3) return '#000000';
      return '#' + nums.slice(0,3).map(n=>('0'+parseInt(n,10).toString(16)).slice(-2)).join('');
    }

    function applySmartColor(color){
      if(!selectedId) return;
      if(selectedId==='qrBox') return;
      if(selectedId==='footer'){
        footerColorHex = color;
        [f1,f2,f3].forEach(n=> {
          if (n) {
            n.style.color = color;
          }
        });
        footer.style.color = color;
      }else{
        const el = $(selectedId);
        if (el) {
          el.style.color = color;
        }
      }
      if (smartColorChip) {
        smartColorChip.style.background = color;
      }
    }

    // ===== iOS Color Picker =====
    const iosColorPicker = $('#iosColorPicker');
    const colorGrid = $('#colorGrid');
    const customColorInput = $('#customColorInput');
    const applyCustomColor = $('#applyCustomColor');
    const cancelColorPicker = $('#cancelColorPicker');
    const confirmColorPicker = $('#confirmColorPicker');
    
    // M√†u s·∫Øc ƒë·ªãnh s·∫µn
    const presetColors = [
      '#355a78', '#0b7cc2', '#0f9b7b', '#e63946',
      '#f4a261', '#2a9d8f', '#e9c46a', '#264653',
      '#000000', '#4a5568', '#718096', '#a0aec0',
      '#ffffff', '#fed7d7', '#feebc8', '#c6f6d5'
    ];
    
    let currentColor = '#355a78';
    let colorPickerCallback = null;
    
    // T·∫°o grid m√†u
    function initColorGrid() {
      if (!colorGrid) return;
      
      colorGrid.innerHTML = '';
      presetColors.forEach(color => {
        const colorOption = document.createElement('div');
        colorOption.className = 'ios-color-option';
        colorOption.style.backgroundColor = color;
        colorOption.dataset.color = color;
        colorOption.addEventListener('click', () => {
          document.querySelectorAll('.ios-color-option').forEach(opt => 
            opt.classList.remove('selected'));
          colorOption.classList.add('selected');
          currentColor = color;
          if (customColorInput) {
            customColorInput.value = color;
          }
        });
        colorGrid.appendChild(colorOption);
      });
    }
    
    // Hi·ªÉn th·ªã color picker
    function showColorPicker(currentColorHex, callback) {
      currentColor = currentColorHex;
      colorPickerCallback = callback;
      if (customColorInput) {
        customColorInput.value = currentColorHex;
      }
      
      // Ch·ªçn m√†u hi·ªán t·∫°i trong grid
      document.querySelectorAll('.ios-color-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.color === currentColorHex) {
          opt.classList.add('selected');
        }
      });
      
      if (iosColorPicker) {
        iosColorPicker.style.display = 'flex';
      }
    }
    
    // ·∫®n color picker
    function hideColorPicker() {
      if (iosColorPicker) {
        iosColorPicker.style.display = 'none';
      }
    }
    
    // √Åp d·ª•ng m√†u t√πy ch·ªânh
    if (applyCustomColor) {
      applyCustomColor.addEventListener('click', () => {
        const color = customColorInput ? customColorInput.value : '';
        if (/^#[0-9A-F]{6}$/i.test(color)) {
          currentColor = color;
          // C·∫≠p nh·∫≠t m√†u trong grid n·∫øu c√≥
          document.querySelectorAll('.ios-color-option').forEach(opt => {
            opt.classList.remove('selected');
          });
        } else {
          alert('M√£ m√†u kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p m√£ hex (v√≠ d·ª•: #ff0000)');
        }
      });
    }
    
    // X√°c nh·∫≠n ch·ªçn m√†u
    if (confirmColorPicker) {
      confirmColorPicker.addEventListener('click', () => {
        if (colorPickerCallback) {
          colorPickerCallback(currentColor);
        }
        hideColorPicker();
      });
    }
    
    // H·ªßy ch·ªçn m√†u
    if (cancelColorPicker) {
      cancelColorPicker.addEventListener('click', hideColorPicker);
    }
    
    // Kh·ªüi t·∫°o color grid
    initColorGrid();

    // ƒê√É S·ª¨A: S·ª≠ d·ª•ng c·∫£ input color g·ªëc v√† color picker t√πy ch·ªânh
    // Tr√™n iOS s·∫Ω s·ª≠ d·ª•ng color picker t√πy ch·ªânh
    // Tr√™n c√°c thi·∫øt b·ªã kh√°c s·∫Ω s·ª≠ d·ª•ng input color g·ªëc
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    if (smartColorChip) {
      smartColorChip.addEventListener('click', () => {
        // L·∫•y m√†u hi·ªán t·∫°i
        let currentColor;
        if (selectedId === 'footer') {
          currentColor = footerColorHex;
        } else if (selectedId && selectedId !== 'qrBox') {
          const el = $(selectedId);
          if (el) {
            currentColor = rgb2hex(getComputedStyle(el).color);
          } else {
            currentColor = '#355a78';
          }
        } else {
          currentColor = '#355a78';
        }
        
        // Tr√™n iOS, s·ª≠ d·ª•ng color picker t√πy ch·ªânh
        // Tr√™n c√°c thi·∫øt b·ªã kh√°c, k√≠ch ho·∫°t input color g·ªëc
        if (isIOS()) {
          showColorPicker(currentColor, (newColor) => {
            applySmartColor(newColor);
            if (smartColorChip) {
              smartColorChip.style.background = newColor;
            }
          });
        } else {
          // ƒê·∫∑t gi√° tr·ªã cho input color v√† k√≠ch ho·∫°t click
          if (smartColor) {
            smartColor.value = currentColor;
            smartColor.click();
          }
        }
      });
    }

    // X·ª≠ l√Ω thay ƒë·ªïi m√†u t·ª´ input color g·ªëc (cho c√°c thi·∫øt b·ªã kh√¥ng ph·∫£i iOS)
    if (smartColor) {
      smartColor.addEventListener('input', (e) => {
        const newColor = e.target.value;
        applySmartColor(newColor);
        if (smartColorChip) {
          smartColorChip.style.background = newColor;
        }
      });
    }

    function setSelected(id){
      ['qrBox','title','accountLine','aliasLine','footer'].forEach(k=> {
        const el = $(k);
        if (el) {
          el.classList.remove('selected');
        }
      });
      selectedId = id; 
      if(!id){ 
        if (smartbar) {
          smartbar.style.display='none'; 
        }
        return; 
      }
      const el = $(id); 
      if (el) {
        el.classList.add('selected'); 
      }
      if (smartTitle) {
        smartTitle.textContent = `Ch·ªânh: ${NAME_MAP[id]||id}`; 
      }
      if (smartCenter) {
        smartCenter.checked = !!center[id];
      }
      if(id==='qrBox'){
        if (smartSize) {
          smartSize.min=80; smartSize.max=420; smartSize.value=parseInt(getComputedStyle(qrBox).width)||200;
        }
        if (smartColorWrap) {
          smartColorWrap.style.display='none';
        }
      }
      else if(id==='footer'){
        if (smartSize) {
          smartSize.min=8; smartSize.max=24; smartSize.value=footerFontPx||10;
        }
        if (smartColorWrap) {
          smartColorWrap.style.display='grid';
        }
        const current = footerColorHex || rgb2hex(getComputedStyle(footer).color);
        if (smartColorChip) {
          smartColorChip.style.background = current;
        }
        if (smartColor) {
          smartColor.value = current;
        }
      }
      else{
        const current = parseInt(getComputedStyle(el).fontSize); 
        if (smartSize) {
          smartSize.min=10; smartSize.max=48; smartSize.value=current||14;
        }
        if (smartColorWrap) {
          smartColorWrap.style.display='grid';
        }
        const c = rgb2hex(getComputedStyle(el).color); 
        if (smartColorChip) {
          smartColorChip.style.background=c;
        }
        if (smartColor) {
          smartColor.value = c;
        }
      }
      if (smartbar) {
        smartbar.style.display='block';
      }
    }
    
    ['qrBox','title','accountLine','aliasLine','footer'].forEach(id=> {
      const el = $(id);
      if (el) {
        el.addEventListener('click', (e)=>{ e.stopPropagation(); setSelected(id); });
      }
    });
    
    document.body.addEventListener('click', (e)=>{ 
      if(!e.target.closest('.smartbar') && !e.target.closest('.panel') && !e.target.closest('.tabs')) { 
        setSelected(null); 
      } 
    });
    
    if (smartClose) {
      smartClose.addEventListener('click', ()=> setSelected(null));
    }

    if (smartSize) {
      smartSize.addEventListener('input', ()=>{
        if(!selectedId) return;
        if(selectedId==='qrBox'){ 
          qrUserSize = parseInt(smartSize.value,10); 
          qrBox.style.width = qrUserSize+'px'; 
          qrBox.style.height = qrUserSize+'px'; 
          applyCenter('qrBox'); 
          return; 
        }
        if(selectedId==='footer'){ 
          footerFontPx = parseInt(smartSize.value,10); 
          [f1,f2,f3].forEach(n=> {
            if (n) {
              n.style.fontSize = footerFontPx + 'px';
            }
          }); 
          return; 
        }
        const el = $(selectedId); 
        if (el) {
          el.style.fontSize = smartSize.value + 'px';
        }
      });
    }
    
    if (smartCenter) {
      smartCenter.addEventListener('change', ()=>{ 
        if(!selectedId) return; 
        center[selectedId] = smartCenter.checked; 
        applyCenter(selectedId); 
      });
    }

    let nudgeTimer=null; const step=3;
    function nudge(id,dx,dy){
      const el=$(id); if(!el) return; const c=rectCard(); 
      let left=el.style.left?parseFloat(el.style.left):(el.getBoundingClientRect().left-c.left); 
      let top=el.style.top?parseFloat(el.style.top):(el.getBoundingClientRect().top-c.top);
      if(center[id]){ 
        top = clamp(top + dy, 0, c.height - el.offsetHeight); 
        el.style.top = top + 'px'; 
      }
      else{ 
        left = clamp(left + dx, 0, c.width - el.offsetWidth); 
        top = clamp(top + dy, 0, c.height - el.offsetHeight); 
        el.style.left = left + 'px'; 
        el.style.top = top + 'px'; 
        el.style.right=''; 
      }
    }
    
    function hold(btn, fn){ 
      if (!btn) return;
      
      const run=()=>fn(); 
      btn.addEventListener('mousedown', ()=>{ run(); nudgeTimer=setInterval(run,100); }); 
      document.addEventListener('mouseup', ()=>{ if(nudgeTimer){ clearInterval(nudgeTimer); nudgeTimer=null; } }); 
      btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); run(); nudgeTimer=setInterval(run,100); }, {passive:false}); 
      document.addEventListener('touchend', ()=>{ if(nudgeTimer){ clearInterval(nudgeTimer); nudgeTimer=null; } }); 
    }
    
    if (nudgeUp) hold(nudgeUp, ()=> selectedId && nudge(selectedId, 0,-step));
    if (nudgeDown) hold(nudgeDown, ()=> selectedId && nudge(selectedId, 0, step));
    if (nudgeLeft) hold(nudgeLeft, ()=> selectedId && nudge(selectedId,-step, 0));
    if (nudgeRight) hold(nudgeRight, ()=> selectedId && nudge(selectedId, step, 0));

    // ===== Footer save/load =====
    const STORAGE_KEY = 'vietinbank_qr_footer_v1';
    const footerSave = $('footerSave');
    const footerLoad = $('footerLoad');
    
    if (footerSave) {
      footerSave.addEventListener('click', ()=>{
        const data = { 
          visible: footerVisible.checked, 
          lines: [
            f1Input ? f1Input.value||'' : '', 
            f2Input ? f2Input.value||'' : '', 
            f3Input ? f3Input.value||'' : ''
          ], 
          color: footerColorHex, 
          size: footerFontPx, 
          centered: !!center.footer 
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        alert('ƒê√£ l∆∞u Footer.');
      });
    }
    
    if (footerLoad) {
      footerLoad.addEventListener('click', ()=>{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw){ alert('Ch∆∞a c√≥ d·ªØ li·ªáu Footer ƒë√£ l∆∞u.'); return; }
        try{
          const data = JSON.parse(raw)||{};
          footerVisible.checked = !!data.visible;
          if (f1Input) f1Input.value = data.lines?.[0] ?? f1Input.value;
          if (f2Input) f2Input.value = data.lines?.[1] ?? f2Input.value;
          if (f3Input) f3Input.value = data.lines?.[2] ?? f3Input.value;
          footerColorHex = data.color || footerColorHex;
          footerFontPx = parseInt(data.size||footerFontPx,10);
          center.footer = !!data.centered;
          [f1,f2,f3].forEach((n,i)=> {
            if (n) {
              n.textContent = [
                f1Input ? f1Input.value : '',
                f2Input ? f2Input.value : '',
                f3Input ? f3Input.value : ''
              ][i];
            }
          });
          updateAll();
          alert('ƒê√£ kh√¥i ph·ª•c Footer.');
        }catch(e){ alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu ƒë√£ l∆∞u.'); }
      });
    }

    [f1Input,f2Input,f3Input].forEach((inp,idx)=> {
      if (inp) {
        inp.addEventListener('input', ()=>{ 
          const target = [f1,f2,f3][idx];
          if (target) {
            target.textContent = inp.value||''; 
          }
        });
      }
    });

    // ===== Init defaults (custom) =====
    if (titleInput) titleInput.value = 'TR·∫¶N KI·∫æM B√åNH';
    if (accInput) accInput.value = '108888884567';
    if (aliasInput) aliasInput.value = 'BINHTK';
    qrUserSize = 210;
    center.qrBox = true;
    center.title = true;
    center.accountLine = true;
    center.aliasLine = true;

    (async()=>{
      const ok = await initGalleryFromGithub();
      if(!ok){ setDefaultBG(); }
      updateQR();
      updateAll();
      renderGallery();
    })();

    requestAnimationFrame(()=>{
      const c = rectCard();
      qrBox.style.left = Math.round(c.width * 0.08) + 'px';
      qrBox.style.top  = Math.round(c.height * 0.22) + 'px';
      qrBox.style.transform = 'translate(0,0)';
      qrBox.style.width = qrUserSize + 'px';
      qrBox.style.height = qrUserSize + 'px';
      title.style.left = Math.round(c.width * 0.08) + 'px';
      title.style.top  = Math.round(c.height * 0.60) + 'px';
      title.style.fontSize = '15px';
      title.style.textAlign = 'left';
      accLine.style.left = Math.round(c.width * 0.08) + 'px';
      accLine.style.top  = Math.round(c.height * 0.65) + 'px';
      accLine.style.fontSize = '15px';
      accLine.style.textAlign = 'left';
      aliasLine.style.left = Math.round(c.width * 0.08) + 'px';
      aliasLine.style.top  = Math.round(c.height * 0.74) + 'px';
      aliasLine.style.fontSize = '14px';
      aliasLine.style.textAlign = 'left';
      applyCenter('qrBox'); applyCenter('title'); applyCenter('accountLine'); applyCenter('aliasLine'); applyCenter('footer');
    });

    async function toDataURL(url){ const res = await fetch(url,{cache:'no-store'}); const blob = await res.blob(); return await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob); }); }

    // ===== Ultimate iOS Solution =====
    const exportBtn = $('exportBtn');
    if (exportBtn) {
      exportBtn.addEventListener('click', async function() {
        const TARGET_W = 1360, TARGET_H = 2040;
        
        // Hi·ªÉn th·ªã tr·∫°ng th√°i loading
        const originalText = this.textContent;
        this.textContent = 'üîÑ ƒêang x·ª≠ l√Ω...';
        this.disabled = true;
        
        try {
          // ·∫®n smartbar t·∫°m th·ªùi
          const sb = $('smartbar'); 
          const prevSB = sb ? sb.style.display : 'none'; 
          if (sb) {
            sb.style.display = 'none';
          }
          
          // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o UI ƒë√£ c·∫≠p nh·∫≠t
          await new Promise(r => setTimeout(r, 100));
          
          const rect = card.getBoundingClientRect();
          const scale = TARGET_W / rect.width;
          
          const canvas = await html2canvas(card, {
            backgroundColor: null, 
            useCORS: true, 
            allowTaint: false, 
            scale: scale, 
            logging: false,
            onclone: (doc) => {
              const img = doc.getElementById('bgImg'); 
              if(img) { 
                img.style.height = '100%'; 
                img.style.width = 'auto'; 
                img.style.left = '50%'; 
                img.style.transform = 'translateX(-50%)'; 
                img.style.top = '0'; 
              }
            }
          });
          
          let out = canvas;
          if(canvas.width !== TARGET_W || canvas.height !== TARGET_H){
            const tmp = document.createElement('canvas');
            tmp.width = TARGET_W; 
            tmp.height = TARGET_H;
            const ctx = tmp.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(canvas, 0, 0, TARGET_W, TARGET_H);
            out = tmp;
          }
          
          const acc = (accInput && accInput.value ? accInput.value.replace(/\D/g, '') : '') || 'VietinBank';
          const filename = `VietinBank_QR_${acc}_${TARGET_W}x${TARGET_H}.png`;
          
          // PH∆Ø∆†NG PH√ÅP CU·ªêI C√ôNG: Chuy·ªÉn h∆∞·ªõng tr·ª±c ti·∫øp ƒë·∫øn data URL
          const dataUrl = out.toDataURL('image/png');
          
          // T·∫°o m·ªôt iframe ·∫©n ƒë·ªÉ t·∫£i ·∫£nh
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = dataUrl;
          document.body.appendChild(iframe);
          
          // Hi·ªÉn th·ªã ·∫£nh tr·ª±c ti·∫øp tr√™n trang v√† h∆∞·ªõng d·∫´n
          showDirectImageDownload(dataUrl, filename);
          
        } catch (error) {
          console.error('Export error:', error);
          // Ph∆∞∆°ng ph√°p d·ª± ph√≤ng c·ª±c k·ª≥ ƒë∆°n gi·∫£n
          showSimpleInstructions();
        } finally {
          // Kh√¥i ph·ª•c smartbar
          const sb = $('smartbar');
          if (sb) {
            sb.style.display = 'block';
          }
          
          // Kh√¥i ph·ª•c tr·∫°ng th√°i n√∫t
          setTimeout(() => {
            if (exportBtn) {
              exportBtn.textContent = originalText;
              exportBtn.disabled = false;
            }
          }, 2000);
        }
      });
    }

    // Ph∆∞∆°ng ph√°p ƒë∆°n gi·∫£n nh·∫•t: hi·ªÉn th·ªã ·∫£nh l·ªõn v√† h∆∞·ªõng d·∫´n
    function showDirectImageDownload(dataUrl, filename) {
      // T·∫°o container
      const container = document.createElement('div');
      container.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
      `;
      
      // T·∫°o n·ªôi dung
      container.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 12px; max-width: 500px; width: 100%; text-align: center;">
          <h3 style="margin: 0 0 15px 0; color: #0b7cc2;">QR Code VietinBank</h3>
          
          <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
            <strong>üì± H∆∞·ªõng d·∫´n l∆∞u ·∫£nh:</strong><br><br>
            1. <strong>Ch·∫°m v√† gi·ªØ</strong> v√†o ·∫£nh b√™n d∆∞·ªõi<br>
            2. Ch·ªçn <strong>"L∆∞u ·∫¢nh ho·∫∑c t·∫£i ·∫£nh"</strong> t·ª´ menu<br>
            3. ·∫¢nh s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o Th∆∞ vi·ªán ·∫£nh c·ªßa b·∫°n
          </div>
          
          <img id="downloadImage" src="${dataUrl}" alt="QR Code" style="max-width: 100%; height: auto; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
          
          <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <button id="printBtn" style="
              background: #0f9b7b;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              font-size: 16px;
              cursor: pointer;
              font-weight: bold;
            ">üñ®Ô∏è In ·∫¢nh</button>
            
            <button id="closeOverlay" style="
              background: #0b7cc2;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              font-size: 16px;
              cursor: pointer;
              font-weight: bold;
            ">ƒê√≥ng</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(container);
      
      container.querySelector('#printBtn').onclick = function() {
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>In QR Code - ${filename}</title>
          <style>
            @media print {
              @page {
                margin: 0;
                size: auto;
              }
              body {
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
              }
            }
            body {
              margin: 0;
              padding: 0;
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              background: white;
            }
            .qr-container {
              width: 100%;
              height: 100%;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            .qr-image {
              max-width: 100%;
              max-height: 100vh;
              width: auto;
              height: auto;
              display: block;
            }
          </style>
        </head>
        <body>
          <div class="qr-container">
            <img class="qr-image" src="${dataUrl}" alt="QR Code VietinBank">
          </div>
        </body>
        </html>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      
      // ƒê·ª£i cho ·∫£nh t·∫£i xong tr∆∞·ªõc khi in
      printWindow.onload = function() {
        printWindow.print();
        
        // ƒê√≥ng c·ª≠a s·ªï in sau khi in (t√πy ch·ªçn)
        // printWindow.onafterprint = function() {
        //   printWindow.close();
        // };
      };
    };
      
      // X·ª≠ l√Ω ƒë√≥ng overlay
      const closeOverlay = container.querySelector('#closeOverlay');
      if (closeOverlay) {
        closeOverlay.onclick = function() {
          document.body.removeChild(container);
        };
      }
      
      // ƒê√≥ng khi click ra ngo√†i
      container.onclick = function(e) {
        if (e.target === container) {
          document.body.removeChild(container);
        }
      };
    }

    // Ph∆∞∆°ng ph√°p d·ª± ph√≤ng si√™u ƒë∆°n gi·∫£n
    function showSimpleInstructions() {
      const message = `
        <div style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 30px;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.3);
          z-index: 10000;
          max-width: 400px;
          width: 90%;
          text-align: center;
        ">
          <h3 style="color: #0b7cc2; margin-bottom: 20px;">H∆∞·ªõng D·∫´n L∆∞u ·∫¢nh</h3>
          <div style="text-align: left; margin-bottom: 25px; font-size: 14px; line-height: 1.6;">
            <p>üì∏ <strong>ƒê·ªÉ l∆∞u ·∫£nh QR Code tr√™n iOS:</strong></p>
            <ol style="margin-left: 20px;">
              <li>Ch·ª•p m√†n h√¨nh ·ª©ng d·ª•ng n√†y</li>
              <li>M·ªü ·∫£nh trong Th∆∞ vi·ªán ·∫£nh</li>
              <li>C·∫Øt ·∫£nh ƒë·ªÉ ch·ªâ l·∫•y ph·∫ßn QR Code</li>
              <li>L∆∞u ·∫£nh ƒë√£ c·∫Øt</li>
            </ol>
          </div>
          <button onclick="this.parentElement.remove()" style="
            background: #0b7cc2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
          ">ƒê√£ Hi·ªÉu</button>
        </div>
      `;
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = message;
      document.body.appendChild(tempDiv.firstElementChild);
    }
  });
  </script>

</body>
</html>
