<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>VietinBank QR</title>
  <style>
    :root{
      --brand:#0b7cc2; --ink:#0a2a44; --muted:#6b7280; --panel:#ffffff; --r:12px;
      --bg1:#e9f6ff; --bg2:#d4edff; --shadow:0 8px 20px rgba(0,0,0,.1);
      --ring:0 0 0 3px rgba(11,124,194,.15);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--ink);background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    .app{height:100vh;height:100dvh;display:flex;flex-direction:column;--preview-height: 73%; /* Chiá»u cao tá»‘i Ä‘a cho pháº§n xem trÆ°á»›c */
    --controls-height: 27%; /* Chiá»u cao tá»‘i thiá»ƒu cho pháº§n Ä‘iá»u khiá»ƒn */}

    /* Preview */
    .preview{flex-shrink:0; display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px;flex: 0 1 var(--preview-height);min-height: 350px;}
    .export-top{display:flex;gap:8px;width:100%;max-width:360px;justify-content: center}
    .btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:10px 12px;border:0;border-radius:8px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    .btn.muted{background:#6b7280}
    .btn.sec{background:#0f9b7b}

    /* Card 2:3 â€” preview DOM; export will render exactly 1360Ã—2040 */
    .card{position:relative;width:min(100%,360px);aspect-ratio:2/3;border-radius:12px;overflow:hidden;box-shadow:0 16px 40px rgba(13,63,97,.2);background:#b7dcff}

    /* Background */
    .bg-wrap{position:absolute;inset:0;overflow:hidden}
    .bg-wrap img{position:absolute;inset:auto;top:0;left:50%;transform:translateX(-50%);height:100%;width:auto;image-rendering:auto;-ms-interpolation-mode:nearest-neighbor}

    .qr-box,.title,.account,.alias,.footer{position:absolute;user-select:none;cursor:grab}
    .qr-box{left:50%;top:28%;transform:translate(-50%,-50%);width:200px;height:200px;background:#fff;border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .qr-box img{display:block;max-width:100%;max-height:100%;border-radius:6px}

    .title{left:50%;top:58%;transform:translate(-50%,0);text-align:center;color:#355a78;text-transform:uppercase;font-weight:800;letter-spacing:.02em;line-height:1.15;font-size:18px;padding:0 8px}
    .account{left:50%;top:66%;transform:translate(-50%,0);text-align:center;color:#355a78;font-weight:800;font-size:16px}
    .alias{left:50%;top:72%;transform:translate(-50%,0);text-align:center;color:#355a78;font-weight:700;font-size:14px;display:none}
    .footer{left:50%;bottom:2%;transform:translate(-50%,0);text-align:center;color:#355a78;font-size:10px;line-height:1.35;font-weight:700;padding:0 8px 8px}

    .dragging{outline:2px solid var(--brand);cursor:grabbing!important;z-index:10}
    .selected{outline:2px solid var(--brand);outline-offset:2px}

    /* Control panel */
    .controls{flex:1;display:flex;flex-direction:column;background:#fff;border-radius:12px 12px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,.08);overflow:hidden;flex: 1 1 var(--controls-height);position:relative}
    .tabs{display:flex;border-bottom:1px solid #e5e7eb;background:#f9fafb;overflow-x:auto}
    .tab{flex:1;padding:8px 10px;font-size:12px;font-weight:700;text-align:center;background:transparent;color:#6b7280;border:0;border-bottom:2px solid transparent;white-space:nowrap}
    .tab.active{color:var(--brand);border-bottom-color:var(--brand);background:#fff}
    .panel{flex:1;overflow:auto;padding:10px}
    .section{background:#f9fafb;border-radius:8px;padding:8px;margin-bottom:8px}
    .section-title{font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:800;letter-spacing:.05em;margin-bottom:6px}
    .field{margin-bottom:6px}
    .label{font-size:11px;color:#6b7280;margin-bottom:2px;font-weight:700}
    input[type="text"],input[type="number"],input[type="color"],textarea{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px}
    input:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:var(--ring)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .check{display:flex;align-items:center;gap:6px;font-size:12px}

    .gallery{display:grid; grid-template-columns:repeat(auto-fill, minmax(72px,1fr)); gap:8px; max-height:144px; overflow:auto}
    @media (max-width:420px){ .gallery{grid-template-columns:repeat(4,1fr)} }
    .g-item{aspect-ratio:1; border-radius:8px; overflow:hidden; border:2px solid transparent; position:relative}
    .g-item img{width:100%; height:100%; object-fit:cover}
    .g-item.selected{border-color:var(--brand)}
    .g-del{position:absolute; top:4px; right:4px; width:22px; height:22px; border-radius:50%; border:0; background:rgba(220,38,38,.95); color:#fff; font-weight:800; cursor:pointer}

    /* Smartbar - FIXED POSITION IN CONTROLS */
    .smartbar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      padding: 12px;
      z-index: 100;
      display: none;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    }
    .smartbar header{display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:6px;user-select:none}
    .smart-title{font-weight:800;font-size:12px}
    .smart-btn{height:36px;width:36px;border-radius:8px;border:1px solid rgba(11,124,194,.2);background:linear-gradient(180deg,#fff,#f6fbff);box-shadow:0 4px 10px rgba(10,42,68,.08);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .smart-close{background:linear-gradient(180deg,#ff8080,#e64040);color:#fff}
    .smart-range{width:100%}

    /* New prominent color chip */
    .smart-color-chip{position:relative;height:36px;width:60px;border-radius:10px;border:2px solid rgba(11,124,194,.35);box-shadow:inset 0 0 0 3px #fff, 0 2px 8px rgba(10,42,68,.12); cursor:pointer}
    .smart-color-chip::after{content:""; position:absolute; inset:-4px; border-radius:12px; box-shadow:0 0 0 2px rgba(11,124,194,.15); pointer-events:none}
    .smart-color-hidden{position:absolute; width:1px; height:1px; padding:0; border:0; clip:rect(0 0 0 0); overflow:hidden;}

    @media (min-width:768px){
      .app{max-width:1200px;margin:0 auto;flex-direction:row;padding:12px;gap:12px}
      .preview{flex:0 0 45%;height:auto; justify-content: center;}
      .card{width:100%;max-width:420px}
      .smartbar{bottom: 0; left: 0; right: 0}
      .controls{border-radius:12px;box-shadow:var(--shadow)}
      .gallery{grid-template-columns:repeat(4,1fr);max-height:220px}
    }
  
    @media (max-width: 640px){
      .gallery{ grid-template-columns:repeat(auto-fill, minmax(72px,1fr)); gap:8px; }
      .g-item img{ height:56px; }
    }
    /* iOS Color Picker Styles */
  .smart-color-chip {
    position: relative;
    height: 36px;
    width: 60px;
    border-radius: 10px;
    border: 2px solid rgba(11,124,194,.35);
    box-shadow: inset 0 0 0 3px #fff, 0 2px 8px rgba(10,42,68,.12);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .smart-color-chip:active {
    transform: scale(0.95);
  }

  #smartColorWrap {
    position: relative;
    display: flex;
    align-items: center;
  }
/* === Compact Gallery (ported from mobile style, tighter) === */
.gallery{display:grid; grid-template-columns:repeat(auto-fill, minmax(72px,1fr)); gap:8px; max-height:144px; overflow:auto}
.gallery-compact{grid-template-columns:repeat(auto-fill, minmax(64px,1fr)); grid-auto-rows:64px}
.g-item{width:100%; height:100%; aspect-ratio:auto; border-radius:8px; overflow:hidden; border:2px solid transparent; position:relative}
.g-item img{width:100%; height:100%; object-fit:cover}
.g-item.selected{ border-color:var(--brand) }
.g-del{position:absolute; top:4px; right:4px; width:22px; height:22px; border-radius:50%; border:0; background:rgba(220,38,38,.95); color:#fff; font-weight:800; cursor:pointer}
.gallery-wrap{border:1px solid #e5e7eb; border-radius:10px; padding:6px; background:#fafafa}
.gallery-wrap > summary{list-style:none; cursor:pointer; font-size:12px; font-weight:700; color:#374151}
.gallery-wrap > summary::-webkit-details-marker{display:none}
@media (max-width:640px){
  .gallery{grid-template-columns:repeat(auto-fill, minmax(56px,1fr)); gap:6px; max-height:128px}
  .gallery-compact{grid-auto-rows:56px}
}

</style>
</head>
<body>
  <div class="app">
    <section class="preview">
      <!-- ÄÃ£ xÃ³a pháº§n export-top -->
      <div class="card hoverable" id="card">
        <div class="bg-wrap"><img id="bgImg" alt="Background" /></div>

        <div class="qr-box hoverable" id="qrBox"><img id="qr" alt="QR" /></div>
        <div class="title hoverable" id="title"><span id="titleText">TÃªn TK: VIETINBANK CN LÃ€O CAI</span></div>
        <div class="account hoverable" id="accountLine"><span id="accountVal">Sá»‘ TK: 108888884567</span></div>
        <div class="alias hoverable" id="aliasLine"><span id="aliasVal">Alias: BINHTK</span></div>
        <div class="footer hoverable" id="footer">
          <div id="f1">VietinBank - CN LÃ o Cai</div>
          <div id="f2">PhÃ²ng Dá»‹ch vá»¥ KhÃ¡ch HÃ ng</div>
          <div id="f3">Äáº¡i lá»™ Tráº§n HÆ°ng Äáº¡o, PhÆ°á»ng Cam ÄÆ°á»ng, Tá»‰nh LÃ o Cai</div>
        </div>
      </div>
    </section>

    <section class="controls">
      <div class="tabs" id="tabs">
        <button class="tab active" data-t="info">ğŸ“ ThÃ´ng tin</button>
        <button class="tab" data-t="bg">ğŸ–¼ï¸ áº¢nh ná»n</button>
        <button class="tab" data-t="footer">ğŸ“„ Footer</button>
        <!-- ThÃªm tab má»›i cho táº£i áº£nh -->
        <button class="tab" data-t="download">â¬‡ï¸ Táº£i áº£nh</button>
      </div>

      <div class="smartbar" id="smartbar">
        <header>
          <div id="smartTitle" class="smart-title">Chá»‰nh sá»­a</div>
          <label class="check"><input type="checkbox" id="smartCenter"> CÄƒn giá»¯a</label>
          <button class="smart-btn smart-close" id="smartClose">âœ•</button>
        </header>
        <div class="controls" style="display:grid;grid-template-columns:repeat(4,36px) 1fr auto;gap:6px;align-items:center">
          <button class="smart-btn" id="nudgeUp">â†‘</button>
          <button class="smart-btn" id="nudgeLeft">â†</button>
          <button class="smart-btn" id="nudgeRight">â†’</button>
          <button class="smart-btn" id="nudgeDown">â†“</button>
          <input class="smart-range" type="range" id="smartSize" min="8" max="48" value="18">
          <div id="smartColorWrap">
            <div class="smart-color-chip" id="smartColorChip" title="Chá»n mÃ u"></div>
            <input class="smart-color-hidden" type="color" id="smartColor">
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-body" data-p="info">
          <div class="section">
            <div class="section-title">ğŸ‘¤ NgÆ°á»i thá»¥ hÆ°á»Ÿng</div>
            <div class="field">
              <input type="text" id="titleInput" placeholder="Nháº­p tÃªn ngÆ°á»i thá»¥ hÆ°á»Ÿng">
            </div>
          </div>
          <div class="section">
            <div class="section-title">ğŸ’³ Sá»‘ tÃ i khoáº£n</div>
            <div class="field">
              <input type="text" id="accInput" inputmode="numeric" placeholder="Nháº­p sá»‘ tÃ i khoáº£n">
            </div>
            <label class="check"><input type="checkbox" id="accVisible" checked> Hiá»ƒn thá»‹ sá»‘ tÃ i khoáº£n</label>
          </div>
          <div class="section">
            <div class="section-title">ğŸ·ï¸ Alias</div>
            <div class="field">
              <input type="text" id="aliasInput" placeholder="Nháº­p alias">
            </div>
            <label class="check"><input type="checkbox" id="aliasVisible"> Hiá»ƒn thá»‹ Alias</label>
          </div>
        </div>

        <div class="panel-body" data-p="bg" hidden>
          <div class="section">
            <div class="section-title">ğŸ–¼ï¸ Chá»n áº£nh ná»n (Size áº£nh 1181x1713)</div>
            <div class="row">
              <button class="btn" id="pickBg" type="button">ğŸ” Chá»n áº£nh</button>
              <button class="btn sec" id="pickDir" type="button">ğŸ“‚ Chá»n thÆ° má»¥c</button>
            </div>
            <input type="file" id="bgFile" accept="image/*" multiple hidden>
            <input type="file" id="dirPicker" accept="image/*" webkitdirectory directory multiple hidden>
          </div>
          <details class="gallery-wrap" style="margin-top:8px">
  <summary id="gallerySummary">ğŸ–¼ï¸ ThÆ° viá»‡n (0) â€” áº¥n Ä‘á»ƒ má»Ÿ</summary>
  <div class="gallery gallery-compact" id="gallery"></div>
</details>
        </div>

        <div class="panel-body" data-p="footer" hidden>
          <div class="section">
            <div class="section-title">ğŸ“„ Ná»™i dung Footer</div>
            <label class="check"><input type="checkbox" id="footerVisible" checked> Hiá»ƒn thá»‹ Footer</label>
            <div class="field"><div class="label">DÃ²ng 1</div><input type="text" id="f1Input" value="VietinBank - CN LÃ o Cai"></div>
            <div class="field"><div class="label">DÃ²ng 2</div><input type="text" id="f2Input" value="PhÃ²ng Dá»‹ch vá»¥ KhÃ¡ch HÃ ng"></div>
            <div class="field"><div class="label">DÃ²ng 3</div><input type="text" id="f3Input" value="Äáº¡i lá»™ Tráº§n HÆ°ng Äáº¡o, PhÆ°á»ng Cam ÄÆ°á»ng, Tá»‰nh LÃ o Cai"></div>
          </div>
          <div class="section">
            <div class="section-title">ğŸ’¾ LÆ°u trá»¯</div>
            <div class="row">
              <button class="btn sec" id="footerSave" type="button">ğŸ’¾ LÆ°u</button>
              <button class="btn muted" id="footerLoad" type="button">â†©ï¸ KhÃ´i phá»¥c</button>
            </div>
          </div>
        </div>

        <!-- ThÃªm panel má»›i cho tab táº£i áº£nh -->
        <div class="panel-body" data-p="download" hidden>
          <div class="section">
            <div class="section-title">â¬‡ï¸ Táº£i áº£nh QR</div>
            <p style="font-size:12px; color: var(--muted); margin-bottom:8px;">Táº£i áº£nh QR Code</p>
            <button class="btn" id="exportBtn" type="button">â¬‡ï¸ Táº£i PNG</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
  const $ = id => document.getElementById(id);
  const card = $('card');
  const bgImg = $('bgImg');
  const qrBox = $('qrBox');
  const qrEl = $('qr');
  const title = $('title');
  const titleText = $('titleText');
  const accLine = $('accountLine');
  const accVal = $('accountVal');
  const aliasLine = $('aliasLine');
  const aliasVal = $('aliasVal');
  const footer = $('footer');
  const f1 = $('f1'), f2 = $('f2'), f3 = $('f3');

  // ===== Tabs =====
  const tabs = $('tabs');
  const panels = [...document.querySelectorAll('[data-p]')];
  tabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab'); if(!btn) return;
    const t = btn.dataset.t;
    tabs.querySelectorAll('.tab').forEach(b=> b.classList.toggle('active', b.dataset.t===t));
    panels.forEach(p => p.hidden = (p.dataset.p !== t));
  });

  // ===== Drag move & center =====
  const center = {qrBox:true, title:true, accountLine:true, aliasLine:true, footer:true};
  let dragTarget=null, offsetX=0, offsetY=0;
  const rectCard = ()=> card.getBoundingClientRect();
  const clamp=(n,min,max)=> Math.max(min, Math.min(max, n));

  function beginDrag(target, x, y){
    dragTarget=target; const r = target.getBoundingClientRect(); const id = target.id;
    if(center[id]){ offsetY = y - r.top; offsetX = (id==='qrBox') ? x - r.left : 0; }
    else { offsetX = x - r.left; offsetY = y - r.top; }
    target.classList.add('dragging');
  }
  function moveDrag(x,y){
    if(!dragTarget) return; const c = rectCard(); const id = dragTarget.id;
    if(center[id]){
      const top = clamp(y - c.top - offsetY, 0, c.height - dragTarget.offsetHeight);
      dragTarget.style.top = top + 'px';
      if(id==='qrBox'){
        const w = dragTarget.offsetWidth; const left = (c.width - w) / 2; dragTarget.style.left = left + 'px'; dragTarget.style.transform = 'translate(0,0)';
      }else{ dragTarget.style.left='0'; dragTarget.style.right='0'; dragTarget.style.textAlign='center'; dragTarget.style.transform='translate(0,0)'; }
    }else{
      const left = clamp(x - c.left - offsetX, 0, c.width - dragTarget.offsetWidth);
      const top  = clamp(y - c.top  - offsetY, 0, c.height - dragTarget.offsetHeight);
      dragTarget.style.left = left + 'px';
      dragTarget.style.top = top + 'px';
      dragTarget.style.right=''; dragTarget.style.transform='translate(0,0)';
    }
  }
  function endDrag(){ if(dragTarget){ dragTarget.classList.remove('dragging'); dragTarget=null; } }
  function wireDrag(id){
    const node=$(id);
    node.addEventListener('mousedown', (e)=>{ e.preventDefault(); beginDrag(node, e.clientX, e.clientY); });
    document.addEventListener('mousemove', (e)=> moveDrag(e.clientX, e.clientY));
    document.addEventListener('mouseup', endDrag);
    node.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; beginDrag(node, t.clientX, t.clientY); }, {passive:false});
    document.addEventListener('touchmove', (e)=>{ if(!dragTarget) return; const t=e.touches[0]; moveDrag(t.clientX,t.clientY); e.preventDefault(); }, {passive:false});
    document.addEventListener('touchend', endDrag);
  }
  ['qrBox','title','accountLine','aliasLine','footer'].forEach(wireDrag);

  function applyCenter(id){
    const el=$(id); const c = rectCard();
    if(center[id]){
      if(id==='qrBox'){
        const w = el.offsetWidth; el.style.left = ((c.width - w)/2) + 'px'; el.style.transform='translate(0,0)';
      }else{
        el.style.left='0'; el.style.right='0'; el.style.textAlign='center'; el.style.transform='translate(0,0)';
      }
    }
  }

  // ===== Inputs =====
  const titleInput=$('titleInput');
  const accInput=$('accInput'), accVisible=$('accVisible');
  const aliasInput=$('aliasInput'), aliasVisible=$('aliasVisible');
  const footerVisible=$('footerVisible'), f1Input=$('f1Input'), f2Input=$('f2Input'), f3Input=$('f3Input');
  let footerFontPx = 10;
  let footerColorHex = '#355a78';
  let qrUserSize = null;

  function updateQR(){
    const acc = (accInput.value||'').replace(/\D/g,'');
    if(acc){
      qrEl.crossOrigin = 'anonymous';
      qrEl.src = `https://img.vietqr.io/image/970415-${acc}-QY3QZ1v.jpg`;
    }
  }

  function updateAll(){
    const c = rectCard();
    const size = (qrUserSize ?? Math.min(220, Math.floor(c.width*0.85)));
    qrBox.style.width = qrBox.style.height = size+'px';
    const tt = (titleInput.value||'').toUpperCase();
    titleText.textContent = 'TÃªn TK: ' + tt;
    accLine.style.display = accVisible.checked ? 'block' : 'none';
    accVal.textContent = 'Sá»‘ TK: ' + (accInput.value||'').replace(/\D/g,'');
    aliasLine.style.display = aliasVisible.checked ? 'block' : 'none';
    aliasVal.textContent = 'Alias: ' + (aliasInput.value||'');
    footer.style.display = footerVisible.checked ? 'block' : 'none';
    [f1,f2,f3].forEach(n => { n.style.fontSize = footerFontPx + 'px'; n.style.color = footerColorHex; });
    footer.style.color = footerColorHex;
    applyCenter('qrBox'); applyCenter('title'); applyCenter('accountLine'); applyCenter('aliasLine'); applyCenter('footer');
  }

  [titleInput, accInput, accVisible, aliasInput, aliasVisible, footerVisible, f1Input, f2Input, f3Input]
    .forEach(n=> n.addEventListener('input', ()=>{ if(n===accInput) updateQR(); updateAll(); }));

  // ===== Gallery / Background loader =====
  const images=[]; let selectedIdx=-1;
  function renderGallery(){ $('gallery').innerHTML = images.map((src,i)=>`<div class="g-item ${i===selectedIdx?'selected':''}" onclick="selectImg(${i})"><img loading="lazy" decoding="async" src="${src}"><button class=\"g-del\" onclick=\"event.stopPropagation();delImg(${i})\">Ã—</button></div>`).join('');
    $('gallerySummary').textContent = `ğŸ–¼ï¸ ThÆ° viá»‡n (${images.length})`; }
  window.selectImg=(i)=>{ selectedIdx=i; bgImg.src = images[i]; renderGallery(); };
  window.delImg=(i)=>{ images.splice(i,1); if(selectedIdx===i){ selectedIdx=images.length?0:-1; if(selectedIdx>=0) selectImg(selectedIdx); else setDefaultBG(); } else if(selectedIdx>i) selectedIdx--; renderGallery(); };
  function addFilesToGallery(files){ if(!files||!files.length) return; let first=images.length===0; for(const f of files){ if(f?.type?.startsWith('image/')){ const r=new FileReader(); r.onload=e=>{ images.push(e.target.result); renderGallery(); if(first){ selectImg(0); first=false; } }; r.readAsDataURL(f); } } }
  $('pickBg').onclick = ()=> $('bgFile').click();
  $('pickDir').onclick = ()=> $('dirPicker').click();
  $('bgFile').onchange = (e)=> addFilesToGallery([...e.target.files]);
  $('dirPicker').onchange = (e)=> addFilesToGallery([...e.target.files]);

  function setDefaultBG(){
    const svg = encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' width='1360' height='2040'>
        <defs>
          <linearGradient id='g' x1='0' x2='1' y1='0' y2='1'>
            <stop offset='0%' stop-color='#e6f3ff'/>
            <stop offset='100%' stop-color='#b7dcff'/>
          </linearGradient>
        </defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <path d='M0,260 C340,200 580,320 1360,220 L1360,0 L0,0 Z' fill='#0b7cc2' fill-opacity='.08'/>
        <path d='M0,420 C420,360 760,500 1360,380 L1360,0 L0,0 Z' fill='#0b7cc2' fill-opacity='.06'/>
      </svg>
    `);
    bgImg.src = 'data:image/svg+xml;charset=utf-8,' + svg;
  }
  
  const GITHUB_SOURCE_DIR = 'source';
  const DEFAULT_BG_NAME   = 'background-default.png';
  function meta(name){ return document.querySelector(`meta[name="${name}"]`)?.content?.trim(); }
  function detectOwnerRepo(){
    const mo = meta('gh-owner'); const mr = meta('gh-repo');
    if(mo && mr) return {owner: mo, repo: mr};
    const {hostname, pathname} = window.location; const parts = pathname.split('/').filter(Boolean);
    if(hostname.endsWith('.github.io') && parts.length>0){ const owner = hostname.split('.')[0]; const repo  = parts[0]; return {owner, repo}; }
    return null;
  }
  async function listImagesViaGitHubAPI(){
    const info = detectOwnerRepo(); if(!info) return [];
    const branches = ['gh-pages','main','master'];
    for(const br of branches){
      const api = `https://api.github.com/repos/${info.owner}/${info.repo}/contents/${GITHUB_SOURCE_DIR}?ref=${br}`;
      try{
        const res = await fetch(api, {headers:{'Accept':'application/vnd.github+json'}, cache:'no-store'}); if(!res.ok) continue;
        const arr = await res.json(); if(!Array.isArray(arr)) continue;
        const imgs = arr.filter(x=>x.type==='file' && /\.(png|jpe?g|webp|svg)$/i.test(x.name)).map(x=>({ name:x.name, raw:`https://raw.githubusercontent.com/${info.owner}/${info.repo}/${br}/${GITHUB_SOURCE_DIR}/${encodeURIComponent(x.name)}` }));
        if(imgs.length) return imgs;
      }catch(e){ /* try next branch */ }
    }
    return [];
  }
  async function initGalleryFromGithub(){
    images.length = 0; selectedIdx = -1;
    const results = await listImagesViaGitHubAPI();
    if(results.length){
      results.forEach(it=> images.push(it.raw));
      const defIdx = results.findIndex(it => it.name.toLowerCase() === DEFAULT_BG_NAME.toLowerCase());
      window.selectImg(defIdx >= 0 ? defIdx : 0);
      return true;
    }
    return false;
  }

// ===== Smartbar =====
  let selectedId = null;
  const smartbar = $('smartbar');
  const smartTitle = $('smartTitle');
  const smartSize = $('smartSize');
  const smartCenter = $('smartCenter');
  const smartClose = $('smartClose');
  const smartColor = $('smartColor');
  const smartColorChip = $('smartColorChip');
  const smartColorWrap = $('smartColorWrap');
  const nudgeUp = $('nudgeUp');
  const nudgeDown = $('nudgeDown');
  const nudgeLeft = $('nudgeLeft');
  const nudgeRight = $('nudgeRight');
  const NAME_MAP = { 'qrBox':'QR Code', 'title':'TÃªn ngÆ°á»i thá»¥ hÆ°á»Ÿng', 'accountLine':'Sá»‘ tÃ i khoáº£n', 'aliasLine':'Alias', 'footer':'Footer' };

  // ===== Fix Color Picker for iOS =====
  function initColorPicker() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    
    if (isIOS) {
      replaceColorPickerForIOS();
    } else {
      // For non-iOS, keep the original color input
      smartColorChip.addEventListener('click', () => smartColor.click());
    }
  }

  function replaceColorPickerForIOS() {
    // Táº¡o palette mÃ u cá»‘ Ä‘á»‹nh cho iOS
    const colorPalette = [
      '#355a78', '#0b7cc2', '#0a2a44', '#000000',
      '#0f9b7b', '#d32f2f', '#f57c00', '#7b1fa2',
      '#ffffff', '#f5f5f5', '#e0e0e0', '#9e9e9e'
    ];

    // XÃ³a input color hiá»‡n táº¡i
    smartColorWrap.innerHTML = '';

    // Táº¡o chip mÃ u má»›i
    const colorChip = document.createElement('div');
    colorChip.className = 'smart-color-chip';
    colorChip.id = 'smartColorChip';
    colorChip.title = 'Chá»n mÃ u';
    colorChip.style.cursor = 'pointer';
    colorChip.style.background = footerColorHex || '#355a78';

    // Táº¡o menu mÃ u
    const colorMenu = document.createElement('div');
    colorMenu.style.cssText = `
      display: none;
      position: absolute;
      bottom: 100%;
      left: 0;
      background: white;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      z-index: 10001;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 8px;
      border: 1px solid #e5e7eb;
    `;

    // ThÃªm cÃ¡c Ã´ mÃ u vÃ o menu
    colorPalette.forEach(color => {
      const colorOption = document.createElement('div');
      colorOption.style.cssText = `
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: ${color};
        cursor: pointer;
        border: 2px solid ${color === '#ffffff' ? '#e5e7eb' : 'transparent'};
      `;
      colorOption.title = color;
      
      colorOption.addEventListener('click', () => {
        applySmartColor(color);
        colorChip.style.background = color;
        colorMenu.style.display = 'none';
      });
      
      colorMenu.appendChild(colorOption);
    });

    // ThÃªm input tÃ¹y chá»‰nh mÃ u
    const customColorInput = document.createElement('input');
    customColorInput.type = 'text';
    customColorInput.placeholder = '#355a78';
    customColorInput.style.cssText = `
      grid-column: 1 / -1;
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 12px;
      text-align: center;
    `;
    
    customColorInput.addEventListener('change', (e) => {
      let color = e.target.value;
      if (!color.startsWith('#')) {
        color = '#' + color;
      }
      if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color)) {
        applySmartColor(color);
        colorChip.style.background = color;
        colorMenu.style.display = 'none';
        e.target.value = '';
      }
    });
    
    colorMenu.appendChild(customColorInput);

    // Sá»± kiá»‡n click chip mÃ u
    colorChip.addEventListener('click', (e) => {
      e.stopPropagation();
      const isVisible = colorMenu.style.display === 'grid';
      colorMenu.style.display = isVisible ? 'none' : 'grid';
    });

    // ÄÃ³ng menu khi click ra ngoÃ i
    document.addEventListener('click', () => {
      colorMenu.style.display = 'none';
    });

    // ThÃªm vÃ o DOM
    smartColorWrap.appendChild(colorChip);
    smartColorWrap.appendChild(colorMenu);
    
    // Äá»‹nh vá»‹ menu
    smartColorWrap.style.position = 'relative';
  }

  // Khá»Ÿi táº¡o color picker khi trang load
  document.addEventListener('DOMContentLoaded', function() {
    initColorPicker();
  });

  function rgb2hex(rgb){
    const nums = (rgb||'').replace(/[^\d,]/g,'').split(',');
    if(nums.length<3) return '#000000';
    return '#' + nums.slice(0,3).map(n=>('0'+parseInt(n,10).toString(16)).slice(-2)).join('');
  }

  function applySmartColor(color) {
    if(!selectedId) return;
    if(selectedId==='qrBox') return;
    
    if(selectedId==='footer'){
      footerColorHex = color;
      [f1,f2,f3].forEach(n => n.style.color = color);
      footer.style.color = color;
    } else {
      $(selectedId).style.color = color;
    }
    
    // Cáº­p nháº­t chip mÃ u
    const chip = $('smartColorChip');
    if(chip) chip.style.background = color;
  }

  //smartColorChip.addEventListener('click', ()=> smartColor.click());
  //smartColor.addEventListener('input', ()=> applySmartColor(smartColor.value));
  
  // REMOVED ALL DRAGGING LOGIC FOR SMARTBAR

  function setSelected(id){
    ['qrBox','title','accountLine','aliasLine','footer'].forEach(k=> $(k).classList.remove('selected'));
    selectedId = id; if(!id){ smartbar.style.display='none'; return; }
    const el = $(id); el.classList.add('selected'); smartTitle.textContent = `Chá»‰nh: ${NAME_MAP[id]||id}`; smartCenter.checked = !!center[id];
    if(id==='qrBox'){
      smartSize.min=80; smartSize.max=420; smartSize.value=parseInt(getComputedStyle(qrBox).width)||200;
      smartColorWrap.style.display='none';
    }
    else if(id==='footer'){
      smartSize.min=8; smartSize.max=24; smartSize.value=footerFontPx||10;
      smartColorWrap.style.display='grid';
      const current = footerColorHex || rgb2hex(getComputedStyle(footer).color);
      smartColor.value = current; smartColorChip.style.background = current;
    }
    else{
      const current = parseInt(getComputedStyle(el).fontSize); smartSize.min=10; smartSize.max=48; smartSize.value=current||14;
      smartColorWrap.style.display='grid';
      const c = rgb2hex(getComputedStyle(el).color); smartColor.value=c; smartColorChip.style.background=c;
    }
    smartbar.style.display='block';
  }
  ['qrBox','title','accountLine','aliasLine','footer'].forEach(id=> $(id).addEventListener('click', (e)=>{ e.stopPropagation(); setSelected(id); }));
  document.body.addEventListener('click', (e)=>{ if(!e.target.closest('.smartbar') && !e.target.closest('.panel') && !e.target.closest('.tabs')) { setSelected(null); } });
  $('smartClose').addEventListener('click', ()=> setSelected(null));

  smartSize.addEventListener('input', ()=>{
    if(!selectedId) return;
    if(selectedId==='qrBox'){ qrUserSize = parseInt(smartSize.value,10); qrBox.style.width = qrUserSize+'px'; qrBox.style.height = qrUserSize+'px'; applyCenter('qrBox'); return; }
    if(selectedId==='footer'){ footerFontPx = parseInt(smartSize.value,10); [f1,f2,f3].forEach(n=> n.style.fontSize = footerFontPx + 'px'); return; }
    const el = $(selectedId); el.style.fontSize = smartSize.value + 'px';
  });
  $('smartCenter').addEventListener('change', ()=>{ if(!selectedId) return; center[selectedId] = $('smartCenter').checked; applyCenter(selectedId); });

  let nudgeTimer=null; const step=3;
  function nudge(id,dx,dy){
    const el=$(id); if(!el) return; const c=rectCard(); let left=el.style.left?parseFloat(el.style.left):(el.getBoundingClientRect().left-c.left); let top=el.style.top?parseFloat(el.style.top):(el.getBoundingClientRect().top-c.top);
    if(center[id]){ top = clamp(top + dy, 0, c.height - el.offsetHeight); el.style.top = top + 'px'; }
    else{ left = clamp(left + dx, 0, c.width - el.offsetWidth); top = clamp(top + dy, 0, c.height - el.offsetHeight); el.style.left = left + 'px'; el.style.top = top + 'px'; el.style.right=''; }
  }
  function hold(btn, fn){ const run=()=>fn(); btn.addEventListener('mousedown', ()=>{ run(); nudgeTimer=setInterval(run,100); }); document.addEventListener('mouseup', ()=>{ if(nudgeTimer){ clearInterval(nudgeTimer); nudgeTimer=null; } }); btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); run(); nudgeTimer=setInterval(run,100); }, {passive:false}); document.addEventListener('touchend', ()=>{ if(nudgeTimer){ clearInterval(nudgeTimer); nudgeTimer=null; } }); }
  hold($('nudgeUp'),   ()=> selectedId && nudge(selectedId, 0,-step));
  hold($('nudgeDown'), ()=> selectedId && nudge(selectedId, 0, step));
  hold($('nudgeLeft'), ()=> selectedId && nudge(selectedId,-step, 0));
  hold($('nudgeRight'),()=> selectedId && nudge(selectedId, step, 0));

  // ===== Footer save/load =====
  const STORAGE_KEY = 'vietinbank_qr_footer_v1';
  $('footerSave').addEventListener('click', ()=>{
    const data = { visible: footerVisible.checked, lines: [f1Input.value||'', f2Input.value||'', f3Input.value||''], color: footerColorHex, size: footerFontPx, centered: !!center.footer };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    alert('ÄÃ£ lÆ°u Footer.');
  });
  $('footerLoad').addEventListener('click', ()=>{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ alert('ChÆ°a cÃ³ dá»¯ liá»‡u Footer Ä‘Ã£ lÆ°u.'); return; }
    try{
      const data = JSON.parse(raw)||{};
      footerVisible.checked = !!data.visible;
      f1Input.value = data.lines?.[0] ?? f1Input.value;
      f2Input.value = data.lines?.[1] ?? f2Input.value;
      f3Input.value = data.lines?.[2] ?? f3Input.value;
      footerColorHex = data.color || footerColorHex;
      footerFontPx = parseInt(data.size||footerFontPx,10);
      center.footer = !!data.centered;
      [f1,f2,f3].forEach((n,i)=> n.textContent = [f1Input.value,f2Input.value,f3Input.value][i]);
      updateAll();
      alert('ÄÃ£ khÃ´i phá»¥c Footer.');
    }catch(e){ alert('KhÃ´ng Ä‘á»c Ä‘Æ°á»£c dá»¯ liá»‡u Ä‘Ã£ lÆ°u.'); }
  });

  [f1Input,f2Input,f3Input].forEach((inp,idx)=> inp.addEventListener('input', ()=>{ [f1,f2,f3][idx].textContent = inp.value||''; }));

  // ===== Init defaults (custom) =====
  titleInput.value = 'TRáº¦N KIáº¾M BÃŒNH';
  accInput.value = '108888884567';
  aliasInput.value = 'BINHTK';
  qrUserSize = 210;
  center.qrBox = true;
  center.title = true;
  center.accountLine = true;
  center.aliasLine = true;

(async()=>{
    const ok = await initGalleryFromGithub();
    if(!ok){ setDefaultBG(); }
    updateQR();
    updateAll();
    renderGallery();
  })();

  requestAnimationFrame(()=>{
    const c = rectCard();
    qrBox.style.left = Math.round(c.width * 0.08) + 'px';
    qrBox.style.top  = Math.round(c.height * 0.22) + 'px';
    qrBox.style.transform = 'translate(0,0)';
    qrBox.style.width = qrUserSize + 'px';
    qrBox.style.height = qrUserSize + 'px';
    title.style.left = Math.round(c.width * 0.08) + 'px';
    title.style.top  = Math.round(c.height * 0.60) + 'px';
    title.style.fontSize = '15px';
    title.style.textAlign = 'left';
    accLine.style.left = Math.round(c.width * 0.08) + 'px';
    accLine.style.top  = Math.round(c.height * 0.65) + 'px';
    accLine.style.fontSize = '15px';
    accLine.style.textAlign = 'left';
    aliasLine.style.left = Math.round(c.width * 0.08) + 'px';
    aliasLine.style.top  = Math.round(c.height * 0.74) + 'px';
    aliasLine.style.fontSize = '14px';
    aliasLine.style.textAlign = 'left';
    applyCenter('qrBox'); applyCenter('title'); applyCenter('accountLine'); applyCenter('aliasLine'); applyCenter('footer');
  });

  async function toDataURL(url){ const res = await fetch(url,{cache:'no-store'}); const blob = await res.blob(); return await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob); }); }

  // ===== Ultimate iOS Solution =====
  $('exportBtn').addEventListener('click', async function() {
    const TARGET_W = 1360, TARGET_H = 2040;
    
    // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i loading
    const originalText = this.textContent;
    this.textContent = 'ğŸ”„ Äang xá»­ lÃ½...';
    this.disabled = true;
    
    try {
      // áº¨n smartbar táº¡m thá»i
      const sb = $('smartbar'); 
      const prevSB = sb.style.display; 
      sb.style.display = 'none';
      
      // Äá»£i má»™t chÃºt Ä‘á»ƒ Ä‘áº£m báº£o UI Ä‘Ã£ cáº­p nháº­t
      await new Promise(r => setTimeout(r, 100));
      
      const rect = card.getBoundingClientRect();
      const scale = TARGET_W / rect.width;
      
      const canvas = await html2canvas(card, {
        backgroundColor: null, 
        useCORS: true, 
        allowTaint: false, 
        scale: scale, 
        logging: false,
        onclone: (doc) => {
          const img = doc.getElementById('bgImg'); 
          if(img) { 
            img.style.height = '100%'; 
            img.style.width = 'auto'; 
            img.style.left = '50%'; 
            img.style.transform = 'translateX(-50%)'; 
            img.style.top = '0'; 
          }
        }
      });
      
      let out = canvas;
      if(canvas.width !== TARGET_W || canvas.height !== TARGET_H){
        const tmp = document.createElement('canvas');
        tmp.width = TARGET_W; 
        tmp.height = TARGET_H;
        const ctx = tmp.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(canvas, 0, 0, TARGET_W, TARGET_H);
        out = tmp;
      }
      
      const acc = (accInput.value || '').replace(/\D/g, '') || 'VietinBank';
      const filename = `VietinBank_QR_${acc}_${TARGET_W}x${TARGET_H}.png`;
      
      // PHÆ¯Æ NG PHÃP CUá»I CÃ™NG: Chuyá»ƒn hÆ°á»›ng trá»±c tiáº¿p Ä‘áº¿n data URL
      const dataUrl = out.toDataURL('image/png');
      
      // Táº¡o má»™t iframe áº©n Ä‘á»ƒ táº£i áº£nh
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = dataUrl;
      document.body.appendChild(iframe);
      
      // Hiá»ƒn thá»‹ áº£nh trá»±c tiáº¿p trÃªn trang vÃ  hÆ°á»›ng dáº«n
      showDirectImageDownload(dataUrl, filename);
      
    } catch (error) {
      console.error('Export error:', error);
      // PhÆ°Æ¡ng phÃ¡p dá»± phÃ²ng cá»±c ká»³ Ä‘Æ¡n giáº£n
      showSimpleInstructions();
    } finally {
      // KhÃ´i phá»¥c smartbar
      const sb = $('smartbar');
      sb.style.display = 'block';
      
      // KhÃ´i phá»¥c tráº¡ng thÃ¡i nÃºt
      setTimeout(() => {
        $('exportBtn').textContent = originalText;
        $('exportBtn').disabled = false;
      }, 2000);
    }
  });

  // PhÆ°Æ¡ng phÃ¡p Ä‘Æ¡n giáº£n nháº¥t: hiá»ƒn thá»‹ áº£nh lá»›n vÃ  hÆ°á»›ng dáº«n
  function showDirectImageDownload(dataUrl, filename) {
    // Táº¡o container
    const container = document.createElement('div');
    container.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    `;
    
    // Táº¡o ná»™i dung
    container.innerHTML = `
      <div style="background: white; padding: 20px; border-radius: 12px; max-width: 500px; width: 100%; text-align: center;">
        <h3 style="margin: 0 0 15px 0; color: #0b7cc2;">QR Code VietinBank</h3>
        
        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0; font-size: 14px;">
          <strong>ğŸ“± HÆ°á»›ng dáº«n lÆ°u áº£nh trÃªn iOS:</strong><br><br>
          1. <strong>Cháº¡m vÃ  giá»¯</strong> vÃ o áº£nh bÃªn dÆ°á»›i<br>
          2. Chá»n <strong>"LÆ°u áº¢nh"</strong> tá»« menu<br>
          3. áº¢nh sáº½ Ä‘Æ°á»£c lÆ°u vÃ o ThÆ° viá»‡n áº£nh cá»§a báº¡n
        </div>
        
        <img src="${dataUrl}" alt="QR Code" style="max-width: 100%; height: auto; border: 2px solid #ddd; border-radius: 8px;">
        
        <div style="margin-top: 20px;">
          <button id="closeOverlay" style="
            background: #0b7cc2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
          ">ÄÃ³ng</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(container);
    
    // Xá»­ lÃ½ Ä‘Ã³ng overlay
    container.querySelector('#closeOverlay').onclick = function() {
      document.body.removeChild(container);
    };
    
    // ÄÃ³ng khi click ra ngoÃ i
    container.onclick = function(e) {
      if (e.target === container) {
        document.body.removeChild(container);
      }
    };
  }

  // PhÆ°Æ¡ng phÃ¡p dá»± phÃ²ng siÃªu Ä‘Æ¡n giáº£n
  function showSimpleInstructions() {
    const message = `
      <div style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 400px;
        width: 90%;
        text-align: center;
      ">
        <h3 style="color: #0b7cc2; margin-bottom: 20px;">HÆ°á»›ng Dáº«n LÆ°u áº¢nh</h3>
        <div style="text-align: left; margin-bottom: 25px; font-size: 14px; line-height: 1.6;">
          <p>ğŸ“¸ <strong>Äá»ƒ lÆ°u áº£nh QR Code trÃªn iOS:</strong></p>
          <ol style="margin-left: 20px;">
            <li>Chá»¥p mÃ n hÃ¬nh á»©ng dá»¥ng nÃ y</li>
            <li>Má»Ÿ áº£nh trong ThÆ° viá»‡n áº£nh</li>
            <li>Cáº¯t áº£nh Ä‘á»ƒ chá»‰ láº¥y pháº§n QR Code</li>
            <li>LÆ°u áº£nh Ä‘Ã£ cáº¯t</li>
          </ol>
        </div>
        <button onclick="this.parentElement.remove()" style="
          background: #0b7cc2;
          color: white;
          border: none;
          padding: 12px 30px;
          border-radius: 8px;
          font-size: 16px;
          cursor: pointer;
          font-weight: bold;
        ">ÄÃ£ Hiá»ƒu</button>
      </div>
    `;
  
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = message;
    document.body.appendChild(tempDiv.firstElementChild);
  }
  </script>
</body>
</html>
